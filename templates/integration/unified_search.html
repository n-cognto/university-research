{% extends "base.html" %}
{% load static %}

{% block title %}Unified Search Results{% endblock %}

{% block extra_css %}
<style>
    .search-header {
        background-color: #f5f5f5;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
    }
    
    .result-section {
        margin-bottom: 30px;
    }
    
    .result-card {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        padding: 15px;
        margin-bottom: 15px;
        transition: transform 0.2s;
    }
    
    .result-card:hover {
        transform: translateY(-3px);
    }
    
    .result-title {
        font-size: 1.2rem;
        font-weight: 500;
        margin-bottom: 5px;
    }
    
    .result-meta {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 10px;
    }
    
    .result-actions {
        margin-top: 10px;
    }
    
    .tab-content {
        padding: 20px;
        background-color: white;
        border-radius: 0 0 8px 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .nav-tabs .nav-item .nav-link {
        font-weight: 500;
    }
    
    .nav-tabs .nav-item .nav-link.active {
        background-color: white;
        border-bottom-color: white;
    }
    
    .result-count-badge {
        font-size: 0.8rem;
        background-color: #e9ecef;
        color: #495057;
        padding: 3px 8px;
        border-radius: 12px;
        margin-left: 5px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container mt-4">
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="{% url 'integration:dashboard' %}">Integration Dashboard</a></li>
            <li class="breadcrumb-item active" aria-current="page">Search Results</li>
        </ol>
    </nav>
    
    <div class="search-header">
        <h2>Search Results for "{{ query }}"</h2>
        
        <form action="{% url 'integration:unified_search' %}" method="get" class="mt-3">
            <div class="input-group">
                <input type="text" class="form-control" name="q" value="{{ query }}" placeholder="Search stations, datasets, climate data...">
                <button class="btn btn-primary" type="submit">Search</button>
            </div>
        </form>
    </div>
    
    {% if search_results %}
        <ul class="nav nav-tabs" id="resultTabs" role="tablist">
            {% if search_results.stations %}
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="stations-tab" data-bs-toggle="tab" data-bs-target="#stations" type="button" role="tab" aria-controls="stations" aria-selected="true">
                    Weather Stations <span class="result-count-badge">{{ search_results.stations|length }}</span>
                </button>
            </li>
            {% endif %}
            
            {% if search_results.datasets %}
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if not search_results.stations %}active{% endif %}" id="datasets-tab" data-bs-toggle="tab" data-bs-target="#datasets" type="button" role="tab" aria-controls="datasets" aria-selected="{% if not search_results.stations %}true{% else %}false{% endif %}">
                    Datasets <span class="result-count-badge">{{ search_results.datasets|length }}</span>
                </button>
            </li>
            {% endif %}
            
            {% if search_results.devices %}
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if not search_results.stations and not search_results.datasets %}active{% endif %}" id="devices-tab" data-bs-toggle="tab" data-bs-target="#devices" type="button" role="tab" aria-controls="devices" aria-selected="{% if not search_results.stations and not search_results.datasets %}true{% else %}false{% endif %}">
                    Field Devices <span class="result-count-badge">{{ search_results.devices|length }}</span>
                </button>
            </li>
            {% endif %}
            
            {% if search_results.climate_data %}
            <li class="nav-item" role="presentation">
                <button class="nav-link {% if not search_results.stations and not search_results.datasets and not search_results.devices %}active{% endif %}" id="climatedata-tab" data-bs-toggle="tab" data-bs-target="#climatedata" type="button" role="tab" aria-controls="climatedata" aria-selected="{% if not search_results.stations and not search_results.datasets and not search_results.devices %}true{% else %}false{% endif %}">
                    Climate Data <span class="result-count-badge">{{ search_results.climate_data|length }}</span>
                </button>
            </li>
            {% endif %}
        </ul>
        
        <div class="tab-content" id="resultTabsContent">
            {% if search_results.stations %}
            <div class="tab-pane fade show active" id="stations" role="tabpanel" aria-labelledby="stations-tab">
                <div class="result-section">
                    {% for station in search_results.stations %}
                        <div class="result-card">
                            <div class="result-title">{{ station.name }}</div>
                            <div class="result-meta">
                                <span class="badge {% if station.is_active %}bg-success{% else %}bg-secondary{% endif %}">{% if station.is_active %}Active{% else %}Inactive{% endif %}</span>
                                {% if station.station_id %}
                                <span class="ml-2">ID: {{ station.station_id }}</span>
                                {% endif %}
                                {% if station.country__name %}
                                <span class="ml-2">{{ station.region|default:"" }}{% if station.region and station.country__name %}, {% endif %}{{ station.country__name }}</span>
                                {% endif %}
                            </div>
                            <div class="result-actions">
                                <a href="{% url 'integration:station_with_datasets' station.id %}" class="btn btn-sm btn-primary">View Details</a>
                                <a href="{% url 'maps:station_detail' station_id=station.id %}" class="btn btn-sm btn-outline-secondary">View in Maps</a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            {% if search_results.datasets %}
            <div class="tab-pane fade {% if not search_results.stations %}show active{% endif %}" id="datasets" role="tabpanel" aria-labelledby="datasets-tab">
                <div class="result-section">
                    {% for dataset in search_results.datasets %}
                        <div class="result-card">
                            <div class="result-title">{{ dataset.title }}</div>
                            <div class="result-meta">
                                <span class="badge 
                                    {% if dataset.status == 'published' %}bg-success
                                    {% elif dataset.status == 'draft' %}bg-warning
                                    {% else %}bg-secondary{% endif %}">
                                    {{ dataset.status|title }}
                                </span>
                                <span class="ml-2">{{ dataset.category__name }}</span>
                                <span class="ml-2">Created by: {{ dataset.created_by__username }}</span>
                                <span class="ml-2">{{ dataset.created_at|date:"M d, Y" }}</span>
                            </div>
                            <div class="result-actions">
                                <a href="{% url 'integration:dataset_with_stations' dataset.id %}" class="btn btn-sm btn-primary">View Details</a>
                                <a href="{% url 'repository:dataset_detail' dataset.id %}" class="btn btn-sm btn-outline-secondary">View in Repository</a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            {% if search_results.devices %}
            <div class="tab-pane fade {% if not search_results.stations and not search_results.datasets %}show active{% endif %}" id="devices" role="tabpanel" aria-labelledby="devices-tab">
                <div class="result-section">
                    {% for device in search_results.devices %}
                        <div class="result-card">
                            <div class="result-title">{{ device.name }}</div>
                            <div class="result-meta">
                                <span class="badge 
                                    {% if device.status == 'active' %}bg-success
                                    {% elif device.status == 'maintenance' %}bg-warning
                                    {% else %}bg-secondary{% endif %}">
                                    {{ device.status|title }}
                                </span>
                                <span class="ml-2">ID: {{ device.device_id }}</span>
                                {% if device.device_type__name %}
                                <span class="ml-2">Type: {{ device.device_type__name }}</span>
                                {% endif %}
                            </div>
                            <div class="result-actions">
                                <a href="{% url 'maps:field_device_detail' device.id %}" class="btn btn-sm btn-primary">View Details</a>
                            </div>
                        </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}
            
            {% if search_results.climate_data %}
            <div class="tab-pane fade {% if not search_results.stations and not search_results.datasets and not search_results.devices %}show active{% endif %}" id="climatedata" role="tabpanel" aria-labelledby="climatedata-tab">
                <div class="result-section">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Station</th>
                                    <th>Date/Time</th>
                                    <th>Temperature</th>
                                    <th>Humidity</th>
                                    <th>Precipitation</th>
                                    <th>Wind Speed</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for data in search_results.climate_data %}
                                    <tr>
                                        <td>{{ data.station__name }}</td>
                                        <td>{{ data.timestamp }}</td>
                                        <td>{% if data.temperature %}{{ data.temperature }}Â°C{% else %}-{% endif %}</td>
                                        <td>{% if data.humidity %}{{ data.humidity }}%{% else %}-{% endif %}</td>
                                        <td>{% if data.precipitation %}{{ data.precipitation }} mm{% else %}-{% endif %}</td>
                                        <td>{% if data.wind_speed %}{{ data.wind_speed }} m/s{% else %}-{% endif %}</td>
                                        <td>
                                            <a href="{% url 'maps:station_detail' station_id=data.station_id %}" class="btn btn-sm btn-outline-primary">View Station</a>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    {% else %}
        {% if query %}
            <div class="alert alert-info">
                No results found for "{{ query }}". Please try a different search term.
            </div>
        {% endif %}
    {% endif %}
</div>
{% endblock %}